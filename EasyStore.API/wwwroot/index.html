<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Система - Каса</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f4f7f6;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            transition: 0.3s;
        }

            body.dark-mode {
                background-color: #1a1a1a;
                color: #e0e0e0;
            }

        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .receipt-container {
            background: #fff;
            border: 2px dashed #333;
            padding: 20px;
            min-height: 450px;
            display: flex;
            flex-direction: column;
            font-family: 'Courier New', monospace;
            border-radius: 10px;
            position: sticky;
            top: 20px;
        }

        .dark-mode .receipt-container {
            background: #2d2d2d;
            color: #fff;
            border-color: #555;
        }

        .product-card {
            border: none;
            border-radius: 12px;
            transition: 0.3s;
            border-left: 5px solid #6c757d;
        }

            .product-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }

        .dark-mode .product-card {
            background: #333;
            color: #fff;
        }

        .cat-btn {
            margin-right: 5px;
            margin-bottom: 5px;
            border-radius: 20px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7rem;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            border-bottom: 1px dotted #ccc;
            font-size: 0.9rem;
        }

        @keyframes blink {
            50% {
                opacity: 0.5;
            }
        }

        .low-stock-alert {
            color: #ff4757;
            font-weight: bold;
            animation: blink 1s linear infinite;
        }

        .euro-price {
            font-size: 0.85em;
            color: #666;
        }

        .dark-mode .euro-price {
            color: #aaa;
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="card p-4 shadow-lg" style="width: 320px; border-radius: 15px;">
            <div class="text-center mb-4"><h3 class="fw-bold">🛒 ВХОД</h3></div>
            <div class="mb-3">
                <label class="form-label small fw-bold">Номер на касиер</label>
                <input type="text" id="login-id" class="form-control text-center" placeholder="Въведи номер">
            </div>
            <div class="mb-3">
                <label class="form-label small fw-bold">Парола</label>
                <input type="password" id="login-pass" class="form-control text-center" placeholder="****">
            </div>
            <button onclick="handleLogin()" class="btn btn-dark w-100 py-2 fw-bold">ВЛИЗАНЕ</button>
            <div id="login-error" class="text-danger mt-3 small text-center" style="display:none;">❌ Грешен номер или парола!</div>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 shadow-lg">
        <div class="container">
            <a class="navbar-brand" href="index.html">🛒 SUPERMARKET POS</a>
            <div class="navbar-nav me-auto">
                <a class="nav-link active" href="index.html">📦 Каса</a>
                <a class="nav-link text-warning fw-bold" href="supply.html">🚚 Доставки</a>
                <a class="nav-link" href="history.html">📜 История</a>
                <a class="nav-link text-info" href="/scalar/v1" target="_blank">🛠 API</a>
                <a class="nav-link text-danger fw-bold" id="admin-link" href="#" style="display:none;" data-bs-toggle="modal" data-bs-target="#adminModal">👥 ПЕРСОНАЛ</a>
            </div>
            <div class="navbar-nav ms-auto align-items-center">
                <button onclick="toggleDarkMode()" class="btn btn-outline-light btn-sm me-3">🌓</button>
                <span id="user-display" class="navbar-text text-light fw-bold border-start ps-3 me-3">👤 Касиер: ...</span>
                <button onclick="logout()" class="btn btn-sm btn-danger">Изход</button>
            </div>
        </div>
    </nav>

    <div class="modal fade" id="adminModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Управление</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="new-id" class="form-control mb-2" placeholder="Номер">
                    <input type="password" id="new-pass" class="form-control mb-2" placeholder="Парола">
                    <button onclick="addNewCashier()" class="btn btn-success w-100 mb-3">ДОБАВИ</button>
                    <div id="staff-list" class="small"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid px-4">
        <div class="row">
            <div class="col-md-7">
                <div class="mb-4">
                    <input type="text" id="search-input" class="form-control mb-3" placeholder="🔍 Търси продукт..." oninput="renderProductsGrid()">
                    <div id="category-filters" class="d-flex flex-wrap">
                        <button class="btn btn-primary cat-btn" id="btn-all" onclick="filterByCategory('all')">Всички</button>
                    </div>
                </div>
                <div id="products-grid" class="row row-cols-1 row-cols-lg-2 g-3"></div>
            </div>

            <div class="col-md-5">
                <div class="receipt-container shadow">
                    <div class="text-center mb-2">
                        <h5 class="fw-bold mb-0">СУПЕРМАРКЕТ</h5>
                        <div id="receipt-cashier-name" class="small fw-bold text-uppercase mt-1"></div>
                        <p id="receipt-date" style="font-size: 0.8rem;" class="text-muted mb-0"></p>
                        <hr class="my-2">
                    </div>
                    <div id="receipt-items" class="flex-grow-1">
                        <p class="text-center text-muted py-5 italic">НЯМА ДОБАВЕНИ ПРОДУКТИ</p>
                    </div>
                    <div class="mt-3">
                        <div class="border-top pt-2">
                            <div class="d-flex justify-content-between align-items-end">
                                <span class="fw-bold fs-4">ОБЩО:</span>
                                <div class="text-end">
                                    <div class="fw-bold fs-2"><span id="receipt-total-bgn">0.00</span> лв.</div>
                                    <div class="text-muted"><span id="receipt-total-eur">0.00</span> €</div>
                                </div>
                            </div>
                        </div>
                        <div id="action-buttons">
                            <button onclick="processSale()" id="btn-sell" class="btn btn-success w-100 mt-3 py-3 fw-bold fs-4" disabled>💳 ПРИКЛЮЧИ</button>
                            <button onclick="clearReceipt()" class="btn btn-link w-100 text-danger mt-1 text-decoration-none small">Изчисти</button>
                        </div>
                        <div id="admin-msg" class="alert alert-warning text-center mt-3" style="display:none;">Админ режим: Само за преглед</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const EUR_RATE = 1.95583;

        // Начални данни + Зареждане от паметта на браузъра
        let cashiers = JSON.parse(localStorage.getItem('pos_users')) || [
            { id: "1", pass: "1111", name: "Касиер 1", role: "user" },
            { id: "2", pass: "2222", name: "Касиер 2", role: "user" },
            { id: "3", pass: "3333", name: "Касиер 3", role: "user" },
            { id: "4", pass: "4444", name: "Касиер 4", role: "user" },
            { id: "admin", pass: "admin", name: "АДМИНИСТРАТОР", role: "admin" }
        ];

        let receipt = [];
        let allProducts = [];
        let currentCategoryId = 'all';

        async function init() {
            checkAuth();
            await loadCategories();
            await loadProducts();
            updateTime();
            setInterval(updateTime, 1000);
        }

        function updateTime() {
            document.getElementById('receipt-date').innerText = new Date().toLocaleString('bg-BG');
        }

        function checkAuth() {
            const user = sessionStorage.getItem('active_cashier');
            const role = sessionStorage.getItem('user_role');
            if (!user) {
                document.getElementById('login-overlay').style.display = 'flex';
            } else {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('user-display').innerText = `👤 ${user}`;
                document.getElementById('receipt-cashier-name').innerText = `Обслужва: ${user}`;

                if (role === 'admin') {
                    document.getElementById('admin-link').style.display = 'block';
                    document.getElementById('action-buttons').style.display = 'none';
                    document.getElementById('admin-msg').style.display = 'block';
                    renderStaffList();
                }
            }
        }

        function handleLogin() {
            const id = document.getElementById('login-id').value;
            const pass = document.getElementById('login-pass').value;
            const found = cashiers.find(u => u.id === id && u.pass === pass);
            if (found) {
                sessionStorage.setItem('active_cashier', found.name);
                sessionStorage.setItem('user_role', found.role || 'user');
                checkAuth();
                renderProductsGrid();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        // --- НОВИ ФУНКЦИИ ЗА ПЕРСОНАЛ ---
        function addNewCashier() {
            const id = document.getElementById('new-id').value.trim();
            const pass = document.getElementById('new-pass').value.trim();
            if (!id || !pass) return;

            if (cashiers.find(c => c.id === id)) {
                alert("Този номер вече съществува!");
                return;
            }

            cashiers.push({ id: id, pass: pass, name: "Касиер " + id, role: "user" });
            localStorage.setItem('pos_users', JSON.stringify(cashiers));
            renderStaffList();
            alert("Добавен!");
        }

        function renderStaffList() {
            const list = document.getElementById('staff-list');
            list.innerHTML = cashiers.filter(c => c.role !== 'admin').map(c => `
                    <div class="d-flex justify-content-between border-bottom py-1">
                        <span>№${c.id} - ${c.name}</span>
                        <button onclick="removeStaff('${c.id}')" class="btn btn-sm text-danger p-0">изтрий</button>
                    </div>
                `).join('');
        }

        function removeStaff(id) {
            cashiers = cashiers.filter(c => c.id !== id);
            localStorage.setItem('pos_users', JSON.stringify(cashiers));
            renderStaffList();
        }
        // ------------------------------

        function logout() { sessionStorage.clear(); location.reload(); }

        async function loadCategories() {
            try {
                const res = await fetch('/api/Categories');
                const categories = await res.json();
                const container = document.getElementById('category-filters');
                categories.forEach(cat => {
                    const btn = document.createElement('button');
                    btn.className = `btn btn-outline-secondary cat-btn`;
                    btn.innerText = cat.name;
                    btn.onclick = (e) => filterByCategory(cat.id, e.target);
                    container.appendChild(btn);
                });
            } catch (err) { console.error(err); }
        }

        async function loadProducts() {
            try {
                const res = await fetch('/api/Products');
                const data = await res.json();
                allProducts = data.sort((a, b) => a.name.localeCompare(b.name));
                renderProductsGrid();
            } catch (err) { console.error(err); }
        }

        function filterByCategory(catId, btnElement) {
            currentCategoryId = catId;
            document.querySelectorAll('.cat-btn').forEach(b => {
                b.classList.remove('btn-primary'); b.classList.add('btn-outline-secondary');
            });
            if (catId === 'all') document.getElementById('btn-all').className = 'btn btn-primary cat-btn';
            else btnElement.className = 'btn btn-primary cat-btn';
            renderProductsGrid();
        }

        function quickAdd(id, val) {
            const input = document.getElementById('qty-' + id);
            input.value = parseFloat(input.value || 0) + val;
        }

        function renderProductsGrid() {
            const grid = document.getElementById('products-grid');
            const term = document.getElementById('search-input').value.toLowerCase();
            const isAdmin = sessionStorage.getItem('user_role') === 'admin';
            const filtered = allProducts.filter(p =>
                p.name.toLowerCase().includes(term) && (currentCategoryId === 'all' || p.categoryId === currentCategoryId)
            );

            grid.innerHTML = filtered.map(p => `
                    <div class="col">
                        <div class="card h-100 product-card shadow-sm">
                            <div class="card-body p-3">
                                <h6 class="fw-bold mb-1">${p.name}</h6>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <span class="badge bg-dark fs-6">${p.price.toFixed(2)} лв.</span>
                                        <div class="euro-price">${(p.price / EUR_RATE).toFixed(2)} €</div>
                                    </div>
                                    <span class="small ${p.stockQuantity <= 3 ? 'low-stock-alert' : ''}">Налично: ${p.stockQuantity}</span>
                                </div>
                                <div class="${isAdmin ? 'd-none' : ''}">
                                    <div class="mb-2 d-flex gap-1">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="quickAdd(${p.id}, 1)">+1</button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="quickAdd(${p.id}, 5)">+5</button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="quickAdd(${p.id}, 10)">+10</button>
                                    </div>
                                    <div class="input-group input-group-sm">
                                        <input type="number" id="qty-${p.id}" value="1" step="any" class="form-control">
                                        <button onclick="addToReceipt(${p.id})" class="btn btn-dark" ${p.stockQuantity <= 0 ? 'disabled' : ''}>➕ ДОБАВИ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
        }

        function addToReceipt(productId) {
            const product = allProducts.find(p => p.id === productId);
            const qtyInput = document.getElementById('qty-' + productId);
            const requestedQty = parseFloat(qtyInput.value);
            if (isNaN(requestedQty) || requestedQty <= 0) { alert("❌ Въведете количество!"); return; }

            let existingItem = receipt.find(x => x.productId === productId);
            let totalRequested = (existingItem ? existingItem.quantity : 0) + requestedQty;

            if (totalRequested > product.stockQuantity) {
                alert(`⚠️ ГРЕШКА: Няма наличност!\nВ склад: ${product.stockQuantity}`);
                return;
            }
            if (existingItem) existingItem.quantity += requestedQty;
            else receipt.push({ productId: product.id, name: product.name, price: product.price, quantity: requestedQty });
            qtyInput.value = 1;
            renderReceipt();
        }

        function renderReceipt() {
            const container = document.getElementById('receipt-items');
            if (receipt.length === 0) {
                container.innerHTML = '<p class="text-center text-muted py-5 italic">НЯМА ДОБАВЕНИ ПРОДУКТИ</p>';
            } else {
                container.innerHTML = receipt.map((item, idx) => `
                        <div class="receipt-item">
                            <div><b>${item.name}</b><br>${item.quantity.toFixed(2)} x ${item.price.toFixed(2)}</div>
                            <div class="text-end">
                                <div>${(item.price * item.quantity).toFixed(2)} лв.</div>
                                <div class="small text-muted">${((item.price * item.quantity) / EUR_RATE).toFixed(2)} €</div>
                                <button class="btn btn-sm text-danger p-0" onclick="removeFromReceipt(${idx})">изтрий</button>
                            </div>
                        </div>
                    `).join('');
            }
            let totalBgn = receipt.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('receipt-total-bgn').innerText = totalBgn.toFixed(2);
            document.getElementById('receipt-total-eur').innerText = (totalBgn / EUR_RATE).toFixed(2);
            document.getElementById('btn-sell').disabled = receipt.length === 0;
        }

        function removeFromReceipt(idx) { receipt.splice(idx, 1); renderReceipt(); }
        function clearReceipt() { if (confirm("Изчистване на бележката?")) { receipt = []; renderReceipt(); } }

        async function processSale() {
            const btn = document.getElementById('btn-sell');
            btn.disabled = true;
            let activeUser = sessionStorage.getItem('active_cashier');
            const transactionGuid = "SALE-" + Date.now();

            try {
                const res = await fetch('/api/Sales/sell-multiple', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(receipt.map(r => ({
                        productId: r.productId,
                        quantity: r.quantity,
                        groupGuid: transactionGuid,
                        cashierName: activeUser
                    })))
                });
                if (res.ok) {
                    alert("✅ Успешна продажба!");
                    receipt = [];
                    renderReceipt();
                    await loadProducts();
                }
            } catch (err) { console.error(err); }
            btn.disabled = false;
        }

        function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
        init();
    </script>
</body>
</html>