<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò—Å—Ç–æ—Ä–∏—è - SUPERMARKET POS</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f0f2f5;
            color: #333;
            font-family: 'Segoe UI', sans-serif;
        }

        .navbar {
            background-color: #212529 !important;
            padding: 0.8rem 1rem;
        }

        .navbar-brand {
            font-weight: bold;
            color: white !important;
        }

        .nav-link {
            color: rgba(255,255,255,0.7) !important;
        }

            .nav-link.active {
                color: #ffc107 !important;
                font-weight: bold;
            }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            margin-top: 20px;
            background: white;
        }

        .card-header {
            background: white;
            border-bottom: 1px solid #eee;
            padding: 1.2rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .receipt-note {
            background: #fff;
            border-left: 8px solid #ffc107; 
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

            .receipt-note.delivery {
                border-left-color: #0dcaf0; 
            }

        .note-header {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed #ccc;
            padding-bottom: 5px;
            margin-bottom: 10px;
            font-size: 0.85rem;
        }

        .price-tag {
            background: #212529;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: bold;
        }

        .badge-delivery {
            background-color: #0dcaf0;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: 600;
        }

        .item-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 3px;
        }

        .total-summary-box {
            background: #212529;
            color: #ffc107;
            padding: 15px;
            border-radius: 0 0 12px 12px;
            text-align: right;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">üõí SUPERMARKET POS</a>
            <div class="navbar-nav me-auto">
                <a class="nav-link" href="index.html">üì¶ –ö–∞—Å–∞</a>
                <a class="nav-link" href="supply.html">üöö –î–æ—Å—Ç–∞–≤–∫–∏</a>
                <a class="nav-link active" href="history.html">üìú –ò—Å—Ç–æ—Ä–∏—è</a>
            </div>
            <div class="d-flex align-items-center text-white">
                <span id="user-display" class="me-3 fw-bold border-start ps-3">üë§ –ö–∞—Å–∏–µ—Ä: ...</span>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header"><span>üìä –û–ë–© –û–¢–ß–ï–¢</span><button onclick="fetchHistory()" class="btn btn-sm btn-outline-secondary">üîÑ</button></div>
                    <div class="card-body p-0">
                        <table class="table mb-0">
                            <tbody id="summary-table"></tbody>
                        </table>
                        <div class="total-summary-box">
                            <small class="d-block text-white">–û–ë–©–ê –°–£–ú–ê –ü–†–û–î–ê–ñ–ë–ò:</small>
                            <h3 class="mb-0 fw-bold" id="grand-total">0.00 –ª–≤.</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-8">
                <h5 class="fw-bold mt-4 mb-3">üìú –•–†–û–ù–û–õ–û–ì–ò–Ø –ù–ê –ë–ï–õ–ï–ñ–ö–ò–¢–ï</h5>
                <div id="history-notes-container"></div>
            </div>
        </div>
    </div>

    <script>
        const fetchHistory = async () => {
            const summaryEl = document.getElementById('summary-table');
            const notesContainer = document.getElementById('history-notes-container');
            const grandTotalEl = document.getElementById('grand-total');
            const userDisplay = document.getElementById('user-display');

            const activeUser = sessionStorage.getItem('active_cashier') || "–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω";
            userDisplay.innerText = `üë§ ${activeUser}`;

            try {
                const response = await fetch('/api/Sales');
                const data = await response.json();

                const salesOnly = data.filter(d => d.totalPrice > 0);
                const summaryGrouped = {};
                let totalSalesSum = 0;

                salesOnly.forEach(s => {
                    if (!summaryGrouped[s.productName]) summaryGrouped[s.productName] = { qty: 0, total: 0 };
                    summaryGrouped[s.productName].qty += s.quantity;
                    summaryGrouped[s.productName].total += s.totalPrice;
                    totalSalesSum += s.totalPrice;
                });

                grandTotalEl.innerText = totalSalesSum.toFixed(2) + " –ª–≤.";

                summaryEl.innerHTML = Object.entries(summaryGrouped)
                    .sort((a, b) => a[0].localeCompare(b[0], 'bg'))
                    .map(([name, info]) => `
                            <tr>
                                <td class="ps-3 py-2 small fw-bold">${name}</td>
                                <td class="small text-center">${info.qty.toFixed(2)}</td>
                                <td class="text-end pe-3 fw-bold">${info.total.toFixed(2)} –ª–≤.</td>
                            </tr>
                        `).join('');

                const transactionGroups = {};
                data.forEach(item => {
                    const guid = item.groupGuid || `SINGLE-${item.id}`;
                    if (!transactionGroups[guid]) {
                        transactionGroups[guid] = {
                            items: [],
                            date: item.saleDate,
                            cashier: item.cashierName || "–°–∏—Å—Ç–µ–º–∞",
                            isDelivery: item.totalPrice === 0,
                            totalSum: 0
                        };
                    }
                    transactionGroups[guid].items.push(item);
                    transactionGroups[guid].totalSum += item.totalPrice;
                });

                const sortedGuids = Object.keys(transactionGroups).sort((a, b) => {
                    return new Date(transactionGroups[b].date) - new Date(transactionGroups[a].date);
                });

                notesContainer.innerHTML = sortedGuids.map(guid => {
                    const group = transactionGroups[guid];
                    const dateStr = new Date(group.date).toLocaleString('bg-BG');

                    return `
                            <div class="receipt-note ${group.isDelivery ? 'delivery' : ''}">
                                <div class="note-header">
                                    <span>üìÖ ${dateStr}</span>
                                    <span>üë§ ${group.cashier}</span>
                                </div>
                                <div class="note-body">
                                    ${group.items.map(i => `
                                        <div class="item-row">
                                            <span>${i.productName} (x${i.quantity.toFixed(2)})</span>
                                            <span>${i.totalPrice > 0 ? i.totalPrice.toFixed(2) + ' –ª–≤.' : ''}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="text-end mt-2 pt-2 border-top">
                                    ${group.isDelivery
                            ? `<span class="badge-delivery">üöö –î–û–°–¢–ê–í–ö–ê</span>`
                            : `<span class="price-tag" style="background:#ffc107; color:#000;">–û–ë–©–û: ${group.totalSum.toFixed(2)} –ª–≤.</span>`}
                                </div>
                            </div>
                        `;
                }).join('');

            } catch (err) { console.error(err); }
        };

        document.addEventListener('DOMContentLoaded', () => {
            fetchHistory();
            setInterval(fetchHistory, 5000);
        });
    </script>
</body>
</html>
